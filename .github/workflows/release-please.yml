name: release-please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go

  goreleaser:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          SCOOP_BUCKET_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          AUR_PRIVATE_KEY: ${{ secrets.AUR_PRIVATE_KEY }}

  # Build Windows installer (.exe) using Inno Setup
  windows-installer:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows release asset
        shell: pwsh
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          $url = "https://github.com/robottwo/bishop/releases/download/v${version}/bish_Windows_x86_64.zip"
          Invoke-WebRequest -Uri $url -OutFile bish_Windows_x86_64.zip
          Expand-Archive -Path bish_Windows_x86_64.zip -DestinationPath installer_files

      - name: Prepare installer files
        shell: pwsh
        run: |
          Copy-Item LICENSE installer_files/
          Copy-Item README.md installer_files/

      - name: Build installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          $env:BISH_VERSION = $version

          # Copy the installer script to the build directory
          Copy-Item packaging/windows/installer.iss installer_files/

          cd installer_files
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Upload installer to release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          $installer = "installer_files/bish_${version}_windows_x86_64_setup.exe"
          gh release upload "v${version}" $installer --clobber

  # Publish to Chocolatey (Windows package manager)
  chocolatey:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows release asset
        shell: pwsh
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          $url = "https://github.com/robottwo/bishop/releases/download/v${version}/bish_Windows_x86_64.zip"
          Invoke-WebRequest -Uri $url -OutFile bish_Windows_x86_64.zip
          $hash = (Get-FileHash -Path bish_Windows_x86_64.zip -Algorithm SHA256).Hash
          echo "CHECKSUM=$hash" >> $env:GITHUB_ENV

      - name: Update Chocolatey package files
        shell: pwsh
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          $checksum = "${{ env.CHECKSUM }}"

          # Update nuspec version
          $nuspec = Get-Content packaging/chocolatey/bish.nuspec
          $nuspec = $nuspec -replace '<version>.*</version>', "<version>$version</version>"
          Set-Content packaging/chocolatey/bish.nuspec $nuspec

          # Update install script with version and checksum
          $install = Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1
          $install = $install -replace "releases/download/v[^/]+/", "releases/download/v$version/"
          $install = $install -replace "checksum64\s*=\s*'[^']*'", "checksum64    = '$checksum'"
          Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1 $install

      - name: Pack and push to Chocolatey
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco pack
          choco push bish.${{ needs.release-please.outputs.version }}.nupkg --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCO_API_KEY }}
        continue-on-error: true  # Don't fail the workflow if Chocolatey push fails

  # Submit to Windows Package Manager (winget)
  winget:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Submit to winget
        uses: vedantmgoyal9/winget-releaser@main
        with:
          identifier: robottwo.bish
          version: ${{ needs.release-please.outputs.version }}
          installers-regex: 'bish_Windows_x86_64\.zip$'
          token: ${{ secrets.WINGET_TOKEN }}
        continue-on-error: true  # Don't fail the workflow if winget submission fails

  # Build macOS DMG installer for Intel (x86_64)
  macos-installer-x86_64:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS x86_64 release asset
        run: |
          version="${{ needs.release-please.outputs.version }}"
          url="https://github.com/robottwo/bishop/releases/download/v${version}/bish_Darwin_x86_64.tar.gz"
          curl -L -o bish_Darwin_x86_64.tar.gz "$url"
          mkdir -p installer_files
          tar -xzf bish_Darwin_x86_64.tar.gz -C installer_files

      - name: Prepare installer files
        run: |
          cp LICENSE installer_files/
          cp README.md installer_files/

      - name: Build DMG installer
        run: |
          version="${{ needs.release-please.outputs.version }}"
          chmod +x packaging/macos/create-dmg.sh
          ./packaging/macos/create-dmg.sh "$version" "x86_64" "installer_files" "."

      - name: Upload DMG to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ needs.release-please.outputs.version }}"
          dmg="bish_${version}_macos_x86_64.dmg"
          gh release upload "v${version}" "$dmg" --clobber

  # Build macOS DMG installer for Apple Silicon (arm64)
  macos-installer-arm64:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS arm64 release asset
        run: |
          version="${{ needs.release-please.outputs.version }}"
          url="https://github.com/robottwo/bishop/releases/download/v${version}/bish_Darwin_arm64.tar.gz"
          curl -L -o bish_Darwin_arm64.tar.gz "$url"
          mkdir -p installer_files
          tar -xzf bish_Darwin_arm64.tar.gz -C installer_files

      - name: Prepare installer files
        run: |
          cp LICENSE installer_files/
          cp README.md installer_files/

      - name: Build DMG installer
        run: |
          version="${{ needs.release-please.outputs.version }}"
          chmod +x packaging/macos/create-dmg.sh
          ./packaging/macos/create-dmg.sh "$version" "arm64" "installer_files" "."

      - name: Upload DMG to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ needs.release-please.outputs.version }}"
          dmg="bish_${version}_macos_arm64.dmg"
          gh release upload "v${version}" "$dmg" --clobber

  # Build and verify Nix package
  nix:
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.release-please.outputs.version }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: nix flake check

      - name: Build package
        run: nix build .#default

      - name: Verify binary
        run: |
          ./result/bin/bish --version
